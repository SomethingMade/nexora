<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loopa Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f3f4f6;
      color: #1f2937;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .card {
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .ad-item {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: transform 0.2s;
    }
    .ad-item:hover {
      transform: translateY(-2px);
    }
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
    .btn-danger:hover {
      background: #b91c1c;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .stat-card {
      background: #fff;
      border-radius: 0.5rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .stat-card h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .stat-card p {
      color: #6b7280;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="card flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Loopa Admin Dashboard</h1>
      <button id="logout-btn" class="btn btn-danger">Log Out</button>
    </header>

    <section class="stats-grid">
      <div class="stat-card">
        <h3 id="total-users">0</h3>
        <p>Total Users</p>
      </div>
      <div class="stat-card">
        <h3 id="total-posts">0</h3>
        <p>Total Posts</p>
      </div>
      <div class="stat-card">
        <h3 id="total-earnings">$0.00</h3>
        <p>Total Earnings</p>
      </div>
      <div class="stat-card">
        <h3 id="total-ads">0</h3>
        <p>Approved Ads</p>
      </div>
    </section>

    <section class="card">
      <h2 class="text-xl font-semibold mb-4">Pending Ads</h2>
      <div id="pending-ads" class="space-y-4"></div>
    </section>

    <section class="card">
      <h2 class="text-xl font-semibold mb-4">Approved Ads</h2>
      <div id="approved-ads" class="space-y-4"></div>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(user => {
      if (!user || user.uid !== 'admin') {
        console.error('Unauthorized access attempt by UID:', user?.uid);
        window.location.href = 'index.html';
        return;
      }
      console.log('Admin logged in:', user.uid);
      loadStats();
      loadPendingAds();
      loadApprovedAds();
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = 'index.html';
      }).catch(e => console.error('Logout error:', e));
    });

    function loadStats() {
      try {
        // Total Users
        db.ref('users').on('value', snap => {
          const users = snap.val() || {};
          document.getElementById('total-users').textContent = Object.keys(users).length;
        });

        // Total Posts
        db.ref('posts').on('value', snap => {
          const posts = snap.val() || {};
          document.getElementById('total-posts').textContent = Object.keys(posts).length;
        });

        // Total Earnings
        db.ref('earnings').on('value', snap => {
          const earnings = snap.val() || {};
          const total = Object.values(earnings).reduce((sum, e) => sum + (e.total || 0), 0);
          document.getElementById('total-earnings').textContent = `$${total.toFixed(2)}`;
        });

        // Total Approved Ads
        db.ref('ads').orderByChild('status').equalTo('approved').on('value', snap => {
          const ads = snap.val() || {};
          document.getElementById('total-ads').textContent = Object.keys(ads).length;
        });
      } catch (e) {
        console.error('Stats loading error:', e);
        alert('Failed to load stats. Check console for details.');
      }
    }

    function loadPendingAds() {
      try {
        db.ref('ads').orderByChild('status').equalTo('pending').on('value', snap => {
          const ads = snap.val() || {};
          const container = document.getElementById('pending-ads');
          container.innerHTML = Object.entries(ads).length === 0
            ? '<p class="text-gray-500">No pending ads.</p>'
            : Object.entries(ads).map(([adId, ad]) => `
                <div class="ad-item">
                  <div class="flex justify-between items-center mb-2">
                    <p class="font-medium">${ad.name}</p>
                    <span class="text-xs text-gray-500">${new Date(ad.timestamp).toLocaleString()}</span>
                  </div>
                  <p class="text-sm mb-2">${ad.text}</p>
                  ${ad.imageUrl ? `<img src="${ad.imageUrl}" class="w-full max-w-xs rounded mb-2" alt="Ad image"/>` : ''}
                  <p class="text-sm mb-2"><a href="${ad.link}" target="_blank" class="text-blue-500 hover:underline">${ad.link}</a></p>
                  <div class="flex gap-2">
                    <button class="btn btn-primary" onclick="updateAdStatus('${adId}', 'approved')">Approve</button>
                    <button class="btn btn-danger" onclick="updateAdStatus('${adId}', 'rejected')">Reject</button>
                  </div>
                </div>
              `).join('');
        });
      } catch (e) {
        console.error('Pending ads error:', e);
        alert('Failed to load pending ads. Check console.');
      }
    }

    function loadApprovedAds() {
      try {
        db.ref('ads').orderByChild('status').equalTo('approved').on('value', snap => {
          const ads = snap.val() || {};
          const container = document.getElementById('approved-ads');
          container.innerHTML = Object.entries(ads).length === 0
            ? '<p class="text-gray-500">No approved ads.</p>'
            : Object.entries(ads).map(([adId, ad]) => {
                return db.ref(`ad_impressions/${adId}`).once('value').then(snap => {
                  const impressions = snap.val() || 0;
                  const earnings = (impressions * 0.01 * 0.6) / 1000; // $10 CPM, 60% share
                  return `
                    <div class="ad-item">
                      <div class="flex justify-between items-center mb-2">
                        <p class="font-medium">${ad.name}</p>
                        <span class="text-xs text-gray-500">${new Date(ad.timestamp).toLocaleString()}</span>
                      </div>
                      <p class="text-sm mb-2">${ad.text}</p>
                      ${ad.imageUrl ? `<img src="${ad.imageUrl}" class="w-full max-w-xs rounded mb-2" alt="Ad image"/>` : ''}
                      <p class="text-sm mb-2"><a href="${ad.link}" target="_blank" class="text-blue-500 hover:underline">${ad.link}</a></p>
                      <p class="text-sm mb-2">Impressions: ${impressions}</p>
                      <p class="text-sm mb-2">Creator Earnings: $${earnings.toFixed(4)}</p>
                      <button class="btn btn-danger" onclick="updateAdStatus('${adId}', 'rejected')">Remove</button>
                    </div>
                  `;
                });
              }).reduce((acc, promise) => acc.then(results => promise.then(result => [...results, result])), Promise.resolve([]))
              .then(html => container.innerHTML = html.join(''))
              .catch(e => console.error('Approved ads render error:', e));
        });
      } catch (e) {
        console.error('Approved ads error:', e);
        alert('Failed to load approved ads. Check console.');
      }
    }

    function updateAdStatus(adId, status) {
      try {
        db.ref(`ads/${adId}`).update({ status }).then(() => {
          console.log(`Ad ${adId} updated to ${status}`);
          alert(`Ad ${status} successfully.`);
        }).catch(e => {
          console.error(`Update ad ${adId} error:`, e);
          alert('Failed to update ad. Check console.');
        });
      } catch (e) {
        console.error('Update ad error:', e);
      }
    }
  </script>
</body>
</html>
